<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <style>

    body {
        background-color: rgba(0, 0, 0, .9);    
    }

    .boundary {
      fill: none;
      stroke: #a5967e;
    }

    .arcs path {
    pointer-events: none;
    /* opacity: .6;*/
    fill: none;
    }

  </style>

</head>

<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v0.min.js"></script>
    <script src="country_refugee.js"></script>

    <script>
        var width = 1300,
            height = 650;

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        var projection = d3.geo.equirectangular()
            .scale(153)
            .translate([width/2,height/2])


        var path = d3.geo.path()
            .projection(projection);


        d3.json("https://gist.githubusercontent.com/abenrob/787723ca91772591b47e/raw/8a7f176072d508218e120773943b595c998991be/world-50m.json", function(error, world) {
            svg.append("g")
                .attr("class", "land")
                .selectAll("path")
                .data([topojson.object(world, world.objects.land)])
                .enter().append("path")
                .attr("d", path);
            svg.append("g")
                .attr("class", "boundary")
                .selectAll("boundary")
                .data([topojson.object(world, world.objects.countries)])
                .enter().append("path")
                .attr("d", path);

                    // draw the curves between each country and Germany
        var arcs = svg.append("g")
            .attr("class", "arcs");

        var line = arcs.selectAll("path")
            .data(arcdata)
            .enter()
            .append("path")
            .style("opacity", 1)
            .attr("d", function(d) {
                return lngLatToArc(d, 'sourceLocation', 'targetLocation', 15);
            })
            .style("stroke", function(d, i) {
                return "url(#line-gradient" + i + ")";
            });

        var gradient = svg.selectAll("linearGradient")
            .data(arcdata)
            .enter()
            .append("linearGradient")
            .attr("id", function(d, i) {
                return "line-gradient" + i;
            })
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", projection(52.5167))
            .attr("y1", projection(13.3833))
            .attr("x2", function(d, i) {
                return projection(arcdata[i].sourceLocation[0]);
            })
            .attr("y2", function(d, i) {
                return projection(arcdata[i].sourceLocation[1]);
            });

        gradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "lightgrey");

        gradient.append("stop")
            .attr("offset", function(d, i) {
                return arcdata[i].gradient[0].offset;
            })
            .attr("stop-color", function(d, i) {
                return arcdata[i].gradient[0].color;
            });
          
        });



    function lngLatToArc(d, sourceName, targetName, bend) {
        bend = .7;

        var sourceLngLat = d[sourceName],
            targetLngLat = d[targetName];
        if (targetLngLat && sourceLngLat) {
            var sourceXY = projection(sourceLngLat),
                targetXY = projection(targetLngLat);
            var sourceX = sourceXY[0],
                sourceY = sourceXY[1];
            var targetX = targetXY[0],
                targetY = targetXY[1];
            var dx = (targetX - sourceX),
                dy = targetY - sourceY,
                dr = Math.sqrt(dx * dx + dy * dy) * bend;

            // var west_of_source = (sourceY - targetY)/2 < 0;
            // if (west_of_source) 
            return "M" + targetX + "," + targetY + "A" + dr + "," + dr + " 0 0,1 " + sourceX + "," + sourceY;
            return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;

        }
        // else {
        // }
    }

    </script>
</body>
</html>